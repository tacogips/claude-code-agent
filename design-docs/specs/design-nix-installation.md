# Nix Installation Design

This document describes how to make the claude-code-peeper tool installable via Nix as a native command.

## Overview

The tool will be packaged as a Nix flake that:
1. Uses [bun2nix](https://github.com/nix-community/bun2nix) to build the Bun-based TypeScript project
2. Installs Bun as a dependency automatically
3. Provides a native command (`claude-code-peeper` or similar)
4. Can be installed system-wide or per-user via `nix profile install`

---

## Reference: How claude-code is Packaged

### nixpkgs Official Package

The official [nixpkgs claude-code package](https://github.com/NixOS/nixpkgs/blob/nixos-unstable/pkgs/by-name/cl/claude-code/package.nix) uses `buildNpmPackage`:

```nix
{ buildNpmPackage, fetchzip, ... }:
buildNpmPackage rec {
  pname = "claude-code";
  version = "2.0.76";

  src = fetchzip {
    url = "https://registry.npmjs.org/@anthropic-ai/claude-code/-/claude-code-${version}.tgz";
    hash = "sha256-xxx";
  };

  dontNpmBuild = true;

  # Disable auto-update
  postFixup = ''
    wrapProgram $out/bin/claude \
      --set CLAUDE_CODE_DISABLE_AUTOUPDATE 1
  '';
}
```

### Alternative: claude-code-overlay

The [claude-code-overlay](https://github.com/ryoppippi/claude-code-overlay) uses pre-built binaries:

- Fetches pre-built binaries from official releases
- Uses `makeWrapper` for environment variable injection
- Supports multiple platforms (x86_64-linux, aarch64-linux, x86_64-darwin, aarch64-darwin)
- Disables telemetry and auto-updates via environment variables

---

## Recommended Approach: bun2nix

For a Bun-based TypeScript project, [bun2nix](https://github.com/nix-community/bun2nix) is the recommended approach.

### What is bun2nix?

bun2nix is a Rust-based tool that converts Bun lock files to Nix expressions for reproducible builds.

**Key Features:**
- Fast (~50ms for 2k+ dependencies)
- AOT compilation support for Bun binaries
- Available as NPM package or Nix binary

### Available Build Functions

| Function | Purpose |
|----------|---------|
| `mkDerivation` | Build Bun packages into standalone binaries |
| `writeBunApplication` | Wrapper for scripts that need runtime dependencies |
| `fetchBunDeps` | Fetch and cache Bun dependencies |
| `hook` | Integration with `stdenv.mkDerivation` |

---

## Implementation Design

### 1. Project Structure

```
claude-code-peeper/
├── flake.nix           # Nix flake definition
├── flake.lock          # Locked dependencies
├── package.json        # Bun package manifest
├── bun.lockb           # Bun lock file
├── bun.nix             # Generated by bun2nix
├── default.nix         # Package definition
├── src/
│   └── main.ts         # Entry point
└── ...
```

### 2. flake.nix

```nix
{
  description = "Claude Code session and task viewer";

  inputs = {
    nixpkgs.url = "github:NixOS/nixpkgs/nixos-unstable";
    bun2nix = {
      url = "github:nix-community/bun2nix";
      inputs.nixpkgs.follows = "nixpkgs";
    };
    flake-utils.url = "github:numtide/flake-utils";
  };

  nixConfig = {
    extra-substituters = [
      "https://cache.nixos.org"
      "https://nix-community.cachix.org"
    ];
    extra-trusted-public-keys = [
      "cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY="
      "nix-community.cachix.org-1:mB9FSh9qf2dCimDSUo8Zy7bkq5CX+/rkCWyvRCYg3Fs="
    ];
  };

  outputs = { self, nixpkgs, bun2nix, flake-utils }:
    flake-utils.lib.eachDefaultSystem (system:
      let
        pkgs = import nixpkgs { inherit system; };
        bun2nixPkg = bun2nix.packages.${system}.default;
      in
      {
        packages = {
          default = pkgs.callPackage ./default.nix {
            bun2nix = bun2nixPkg;
          };

          claude-code-peeper = self.packages.${system}.default;
        };

        devShells.default = pkgs.mkShell {
          packages = with pkgs; [
            bun
            bun2nixPkg
            typescript
          ];
        };

        apps.default = {
          type = "app";
          program = "${self.packages.${system}.default}/bin/claude-code-peeper";
        };
      }
    );
}
```

### 3. default.nix (Package Definition)

```nix
{ bun2nix, lib, ... }:

bun2nix.mkDerivation {
  pname = "claude-code-peeper";
  version = "0.1.0";

  src = ./.;

  bunDeps = bun2nix.fetchBunDeps {
    bunNix = ./bun.nix;
  };

  # Entry point
  module = "src/main.ts";

  # Build to bytecode for faster startup
  bunCompileToBytecode = true;

  meta = with lib; {
    description = "Claude Code session and task viewer";
    homepage = "https://github.com/tacogips/claude-code-peeper";
    license = licenses.mit;
    maintainers = [ ];
    mainProgram = "claude-code-peeper";
    platforms = platforms.unix;
  };
}
```

### 4. Generate bun.nix

Add to `package.json`:

```json
{
  "scripts": {
    "postinstall": "bun2nix -o bun.nix"
  },
  "devDependencies": {
    "bun2nix": "^2.0.6"
  }
}
```

Run to generate:

```bash
bun install
# This generates bun.nix via postinstall hook
```

---

## Installation Methods

### Method 1: Direct Flake Install

```bash
# Install from GitHub
nix profile install github:tacogips/claude-code-peeper

# Or from local directory
nix profile install .

# Run without installing
nix run github:tacogips/claude-code-peeper
```

### Method 2: Add to NixOS/Home Manager Configuration

```nix
# In configuration.nix or home.nix
{
  inputs.claude-code-peeper.url = "github:tacogips/claude-code-peeper";
}

# Then in packages:
environment.systemPackages = [
  inputs.claude-code-peeper.packages.${system}.default
];

# Or for home-manager:
home.packages = [
  inputs.claude-code-peeper.packages.${pkgs.system}.default
];
```

### Method 3: Use as Overlay

```nix
{
  nixpkgs.overlays = [
    (final: prev: {
      claude-code-peeper = inputs.claude-code-peeper.packages.${prev.system}.default;
    })
  ];
}
```

---

## Build Process

### Development Workflow

```bash
# 1. Enter dev shell
nix develop

# 2. Install dependencies
bun install

# 3. Build and test locally
bun run build
bun run test

# 4. Build Nix package
nix build

# 5. Test the built package
./result/bin/claude-code-peeper --help
```

### CI/CD Integration

```yaml
# .github/workflows/nix.yml
name: Nix Build
on: [push, pull_request]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v24
        with:
          nix_path: nixpkgs=channel:nixos-unstable
      - uses: cachix/cachix-action@v14
        with:
          name: nix-community
      - run: nix build
      - run: nix flake check
```

---

## Platform Support

| Platform | Support |
|----------|---------|
| x86_64-linux | Primary |
| aarch64-linux | Supported |
| x86_64-darwin | Supported |
| aarch64-darwin | Supported (Apple Silicon) |

---

## Alternative: Binary Distribution

If bun2nix build is too slow or complex, consider distributing pre-built binaries:

```nix
{ stdenv, fetchurl, makeWrapper, ... }:

stdenv.mkDerivation rec {
  pname = "claude-code-peeper";
  version = "0.1.0";

  src = fetchurl {
    url = "https://github.com/tacogips/claude-code-peeper/releases/download/v${version}/claude-code-peeper-${stdenv.hostPlatform.system}";
    sha256 = "sha256-xxx";
  };

  nativeBuildInputs = [ makeWrapper ];

  dontUnpack = true;
  dontBuild = true;

  installPhase = ''
    mkdir -p $out/bin
    install -m755 $src $out/bin/claude-code-peeper
  '';
}
```

Build standalone binaries with Bun:

```bash
bun build src/main.ts --compile --outfile claude-code-peeper
```

---

## Summary

| Aspect | Recommendation |
|--------|----------------|
| Build Tool | bun2nix |
| Entry Point | `src/main.ts` |
| Binary Output | Single executable via `bun build --compile` |
| Flake Structure | Standard with bun2nix input |
| Installation | `nix profile install` or flake reference |
| CI | GitHub Actions with Cachix |

---

## References

- [bun2nix Documentation](https://nix-community.github.io/bun2nix/)
- [bun2nix GitHub](https://github.com/nix-community/bun2nix)
- [nixpkgs claude-code package](https://github.com/NixOS/nixpkgs/blob/nixos-unstable/pkgs/by-name/cl/claude-code/package.nix)
- [claude-code-overlay](https://github.com/ryoppippi/claude-code-overlay)
- [Bun Executables Documentation](https://bun.sh/docs/bundler/executables)
- [NixOS Discourse: bun2nix announcement](https://discourse.nixos.org/t/announcing-bun2nix-build-bun-based-projects-with-nix/62220)

See `design-docs/references/README.md` for additional references.
