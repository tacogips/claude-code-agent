# Deployment Specification

This document describes how to package and install claude-code-agent via Nix.

---

## 1. Overview

The tool is packaged as a Nix flake that:
1. Uses [bun2nix](https://github.com/nix-community/bun2nix) to build the Bun-based TypeScript project
2. Installs Bun as a dependency automatically
3. Provides a native command (`claude-code-agent`)
4. Can be installed system-wide or per-user via `nix profile install`

---

## 2. Build Approach: bun2nix

### 2.1 Why bun2nix?

bun2nix is a Rust-based tool that converts Bun lock files to Nix expressions for reproducible builds.

**Key Features:**
- Fast (~50ms for 2k+ dependencies)
- AOT compilation support for Bun binaries
- Available as NPM package or Nix binary

### 2.2 Available Build Functions

| Function | Purpose |
|----------|---------|
| `mkDerivation` | Build Bun packages into standalone binaries |
| `writeBunApplication` | Wrapper for scripts that need runtime dependencies |
| `fetchBunDeps` | Fetch and cache Bun dependencies |
| `hook` | Integration with `stdenv.mkDerivation` |

---

## 3. Project Structure

```
claude-code-agent/
+-- flake.nix           # Nix flake definition
+-- flake.lock          # Locked dependencies
+-- package.json        # Bun package manifest
+-- bun.lockb           # Bun lock file
+-- bun.nix             # Generated by bun2nix
+-- default.nix         # Package definition
+-- src/
    +-- main.ts         # Entry point
```

---

## 4. Flake Configuration

### 4.1 flake.nix

```nix
{
  description = "Claude Code session and task viewer";

  inputs = {
    nixpkgs.url = "github:NixOS/nixpkgs/nixos-unstable";
    bun2nix = {
      url = "github:nix-community/bun2nix";
      inputs.nixpkgs.follows = "nixpkgs";
    };
    flake-utils.url = "github:numtide/flake-utils";
  };

  nixConfig = {
    extra-substituters = [
      "https://cache.nixos.org"
      "https://nix-community.cachix.org"
    ];
    extra-trusted-public-keys = [
      "cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY="
      "nix-community.cachix.org-1:mB9FSh9qf2dCimDSUo8Zy7bkq5CX+/rkCWyvRCYg3Fs="
    ];
  };

  outputs = { self, nixpkgs, bun2nix, flake-utils }:
    flake-utils.lib.eachDefaultSystem (system:
      let
        pkgs = import nixpkgs { inherit system; };
        bun2nixPkg = bun2nix.packages.${system}.default;
      in
      {
        packages = {
          default = pkgs.callPackage ./default.nix {
            bun2nix = bun2nixPkg;
          };
          claude-code-agent = self.packages.${system}.default;
        };

        devShells.default = pkgs.mkShell {
          packages = with pkgs; [
            bun
            bun2nixPkg
            typescript
          ];
        };

        apps.default = {
          type = "app";
          program = "${self.packages.${system}.default}/bin/claude-code-agent";
        };
      }
    );
}
```

### 4.2 default.nix

```nix
{ bun2nix, lib, ... }:

bun2nix.mkDerivation {
  pname = "claude-code-agent";
  version = "0.1.0";

  src = ./.;

  bunDeps = bun2nix.fetchBunDeps {
    bunNix = ./bun.nix;
  };

  module = "src/main.ts";
  bunCompileToBytecode = true;

  meta = with lib; {
    description = "Claude Code session and task viewer";
    homepage = "https://github.com/tacogips/claude-code-agent";
    license = licenses.mit;
    mainProgram = "claude-code-agent";
    platforms = platforms.unix;
  };
}
```

---

## 5. Generate bun.nix

### 5.1 Via package.json Script

```json
{
  "scripts": {
    "postinstall": "bun2nix -o bun.nix"
  },
  "devDependencies": {
    "bun2nix": "^2.0.6"
  }
}
```

### 5.2 Manual Generation

```bash
bun install
# Generates bun.nix via postinstall hook
```

---

## 6. Installation Methods

### 6.1 Direct Flake Install

```bash
# Install from GitHub
nix profile install github:tacogips/claude-code-agent

# Install from local directory
nix profile install .

# Run without installing
nix run github:tacogips/claude-code-agent
```

### 6.2 NixOS/Home Manager Configuration

```nix
# In configuration.nix or home.nix
{
  inputs.claude-code-agent.url = "github:tacogips/claude-code-agent";
}

# For NixOS:
environment.systemPackages = [
  inputs.claude-code-agent.packages.${system}.default
];

# For home-manager:
home.packages = [
  inputs.claude-code-agent.packages.${pkgs.system}.default
];
```

### 6.3 Use as Overlay

```nix
{
  nixpkgs.overlays = [
    (final: prev: {
      claude-code-agent = inputs.claude-code-agent.packages.${prev.system}.default;
    })
  ];
}
```

---

## 7. Development Workflow

```bash
# 1. Enter dev shell
nix develop

# 2. Install dependencies
bun install

# 3. Build and test locally
bun run build
bun run test

# 4. Build Nix package
nix build

# 5. Test the built package
./result/bin/claude-code-agent --help
```

---

## 8. CI/CD Integration

### 8.1 GitHub Actions Workflow

```yaml
# .github/workflows/nix.yml
name: Nix Build
on: [push, pull_request]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v24
        with:
          nix_path: nixpkgs=channel:nixos-unstable
      - uses: cachix/cachix-action@v14
        with:
          name: nix-community
      - run: nix build
      - run: nix flake check
```

---

## 9. Platform Support

| Platform | Support |
|----------|---------|
| x86_64-linux | Primary |
| aarch64-linux | Supported |
| x86_64-darwin | Supported |
| aarch64-darwin | Supported (Apple Silicon) |

---

## 10. Alternative: Binary Distribution

If bun2nix build is too slow or complex, pre-built binaries can be distributed:

### 10.1 Build Standalone Binary

```bash
bun build src/main.ts --compile --outfile claude-code-agent
```

### 10.2 Nix Package for Pre-built Binary

```nix
{ stdenv, fetchurl, makeWrapper, ... }:

stdenv.mkDerivation rec {
  pname = "claude-code-agent";
  version = "0.1.0";

  src = fetchurl {
    url = "https://github.com/tacogips/claude-code-agent/releases/download/v${version}/claude-code-agent-${stdenv.hostPlatform.system}";
    sha256 = "sha256-xxx";
  };

  nativeBuildInputs = [ makeWrapper ];
  dontUnpack = true;
  dontBuild = true;

  installPhase = ''
    mkdir -p $out/bin
    install -m755 $src $out/bin/claude-code-agent
  '';
}
```

---

## 11. Summary

| Aspect | Recommendation |
|--------|----------------|
| Build Tool | bun2nix |
| Entry Point | `src/main.ts` |
| Binary Output | Single executable via `bun build --compile` |
| Flake Structure | Standard with bun2nix input |
| Installation | `nix profile install` or flake reference |
| CI | GitHub Actions with Cachix |

---

## 12. References

- [bun2nix Documentation](https://nix-community.github.io/bun2nix/)
- [bun2nix GitHub](https://github.com/nix-community/bun2nix)
- [nixpkgs claude-code package](https://github.com/NixOS/nixpkgs/blob/nixos-unstable/pkgs/by-name/cl/claude-code/package.nix)
- [claude-code-overlay](https://github.com/ryoppippi/claude-code-overlay)
- [Bun Executables Documentation](https://bun.sh/docs/bundler/executables)
