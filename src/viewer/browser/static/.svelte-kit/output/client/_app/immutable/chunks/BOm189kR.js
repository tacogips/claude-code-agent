class o{ws=null;url;subscriptions=new Set;messageHandlers=[];stateChangeHandlers=[];reconnectAttempts=0;maxReconnectAttempts=10;reconnectDelayMs=1e3;maxReconnectDelayMs=3e4;reconnectTimeoutId=null;connectionState="disconnected";shouldReconnect=!0;constructor(e){if(e!==void 0)this.url=e;else{const t=window.location.protocol==="https:"?"wss:":"ws:";this.url=`${t}//${window.location.host}/ws`}this.connect()}get state(){return this.connectionState}connect(){if(!(this.ws!==null&&this.ws.readyState===WebSocket.OPEN)){this.setConnectionState(this.reconnectAttempts>0?"reconnecting":"connecting");try{this.ws=new WebSocket(this.url),this.ws.addEventListener("open",()=>{this.onOpen()}),this.ws.addEventListener("message",e=>{this.handleMessage(e)}),this.ws.addEventListener("close",()=>{this.onClose()}),this.ws.addEventListener("error",e=>{this.onError(e)})}catch(e){console.error("WebSocket connection failed:",e),this.scheduleReconnect()}}}onOpen(){console.log("WebSocket connected"),this.reconnectAttempts=0,this.setConnectionState("connected");for(const e of this.subscriptions)this.sendMessage({type:"subscribe",sessionId:e})}handleMessage(e){try{const t=JSON.parse(String(e.data));for(const s of this.messageHandlers)try{s(t)}catch(n){console.error("Message handler error:",n)}}catch(t){console.error("Failed to parse WebSocket message:",t)}}onClose(){console.log("WebSocket disconnected"),this.setConnectionState("disconnected"),this.shouldReconnect&&this.scheduleReconnect()}onError(e){console.error("WebSocket error:",e)}scheduleReconnect(){if(!this.shouldReconnect)return;if(this.reconnectAttempts>=this.maxReconnectAttempts){console.error(`Max reconnect attempts (${this.maxReconnectAttempts}) reached`),this.setConnectionState("disconnected");return}const e=Math.min(this.reconnectDelayMs*Math.pow(2,this.reconnectAttempts),this.maxReconnectDelayMs);console.log(`Reconnecting in ${e}ms (attempt ${this.reconnectAttempts+1})`),this.reconnectTimeoutId=setTimeout(()=>{this.reconnectAttempts++,this.connect()},e)}sendMessage(e){if(this.ws===null||this.ws.readyState!==WebSocket.OPEN){console.warn("Cannot send message: WebSocket not connected");return}try{this.ws.send(JSON.stringify(e))}catch(t){console.error("Failed to send message:",t)}}setConnectionState(e){if(this.connectionState!==e){this.connectionState=e;for(const t of this.stateChangeHandlers)try{t(e)}catch(s){console.error("State change handler error:",s)}}}subscribe(e){this.subscriptions.add(e),this.sendMessage({type:"subscribe",sessionId:e})}unsubscribe(e){this.subscriptions.delete(e),this.sendMessage({type:"unsubscribe",sessionId:e})}onMessage(e){return this.messageHandlers.push(e),()=>{const t=this.messageHandlers.indexOf(e);t!==-1&&this.messageHandlers.splice(t,1)}}onStateChange(e){return this.stateChangeHandlers.push(e),()=>{const t=this.stateChangeHandlers.indexOf(e);t!==-1&&this.stateChangeHandlers.splice(t,1)}}close(){this.shouldReconnect=!1,this.reconnectTimeoutId!==null&&(clearTimeout(this.reconnectTimeoutId),this.reconnectTimeoutId=null),this.ws!==null&&(this.ws.close(),this.ws=null),this.setConnectionState("disconnected")}}const r=new o;export{r as w};
